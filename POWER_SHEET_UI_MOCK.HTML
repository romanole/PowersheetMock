
import { Database, Table, BarChart3, Calculator, Save, Upload, Plus, ChevronDown, Activity, Filter, Settings } from 'lucide-react';

// --- MOCK DATA GENERATOR ---
// In a real scenario, this is replaced by DuckDB Wasm
const TOTAL_ROWS = 1000000; // 1 Million Rows
const ROW_HEIGHT = 32;
const VISIBLE_BUFFER = 10;

// Generating realistic looking fake data headers
const COLUMNS = [
  { id: 'id', name: 'ID', width: 80, type: 'int' },
  { id: 'product', name: 'Product Name', width: 200, type: 'string' },
  { id: 'category', name: 'Category', width: 150, type: 'string' },
  { id: 'date', name: 'Sale Date', width: 120, type: 'date' },
  { id: 'region', name: 'Region', width: 120, type: 'string' },
  { id: 'quantity', name: 'Qty', width: 80, type: 'int' },
  { id: 'price', name: 'Unit Price', width: 100, type: 'currency' },
  { id: 'total', name: 'Total ($)', width: 120, type: 'currency' }, // Computed
  { id: 'status', name: 'Status', width: 120, type: 'tag' },
];

// Helper to simulate data fetching from DB
const fetchMockData = (start, end) => {
  return new Promise((resolve) => {
    // Simulate slight network/db delay (10ms)
    setTimeout(() => {
      const data = [];
      for (let i = start; i < end; i++) {
        const qty = (i % 50) + 1;
        const price = ((i % 100) * 1.5 + 10).toFixed(2);
        data.push({
          id: i + 1,
          product: `Product_SKU_${(i % 1000).toString().padStart(4, '0')}`,
          category: ['Electronics', 'Home', 'Office', 'Tools', 'Garden'][i % 5],
          date: new Date(2023, 0, 1 + (i % 365)).toISOString().split('T')[0],
          region: ['North', 'South', 'East', 'West', 'EU'][i % 5],
          quantity: qty,
          price: price,
          total: (qty * price).toFixed(2),
          status: i % 10 === 0 ? 'Refunded' : 'Completed'
        });
      }
      resolve(data);
    }, 5); 
  });
};

const App = () => {
  // State
  const [scrollTop, setScrollTop] = useState(0);
  const [containerHeight, setContainerHeight] = useState(0);
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [selectedCell, setSelectedCell] = useState(null);
  const [formula, setFormula] = useState('');
  const [activeTab, setActiveTab] = useState('grid'); // 'grid' | 'pivot'

  const containerRef = useRef(null);

  // Calculate Virtual Window
  const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
  const endIndex = Math.min(
    TOTAL_ROWS,
    startIndex + Math.ceil(containerHeight / ROW_HEIGHT) + VISIBLE_BUFFER
  );
  
  const totalHeight = TOTAL_ROWS * ROW_HEIGHT;
  const offsetY = startIndex * ROW_HEIGHT;

  // Resize observer for container
  useEffect(() => {
    if (containerRef.current) {
      setContainerHeight(containerRef.current.clientHeight);
      const observer = new ResizeObserver(entries => {
        setContainerHeight(entries[0].contentRect.height);
      });
      observer.observe(containerRef.current);
      return () => observer.disconnect();
    }
  }, []);

  // Fetch Data on Scroll (Mocking DuckDB LIMIT/OFFSET)
  useEffect(() => {
    setLoading(true);
    fetchMockData(startIndex, endIndex).then(rows => {
      setData(rows);
      setLoading(false);
    });
  }, [startIndex, endIndex]); // Dependency on scroll window

  // Handle Scroll
  const handleScroll = (e) => {
    setScrollTop(e.target.scrollTop);
  };

  // Cell Click
  const handleCellClick = (row, colId, value) => {
    setSelectedCell({ rowId: row.id, colId });
    setFormula(value); // Sync formula bar
  };

  return (
    <div className="flex flex-col h-screen bg-slate-50 text-slate-800 font-sans overflow-hidden">
      {/* 1. TOP BAR */}
      <div className="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 shadow-sm z-20">
        <div className="flex items-center gap-3">
          <div className="bg-emerald-600 text-white p-1.5 rounded-lg">
            <Database size={20} />
          </div>
          <h1 className="font-bold text-lg text-slate-800">InfinitySheet <span className="text-xs font-normal text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full border border-slate-200">DuckDB Core</span></h1>
          <div className="h-6 w-px bg-slate-200 mx-2"></div>
          <div className="text-xs text-slate-500 flex items-center gap-2">
            <span className="font-mono bg-slate-100 px-1.5 py-0.5 rounded text-slate-600">{TOTAL_ROWS.toLocaleString()} rows</span>
            <span>loaded in memory</span>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <button 
            onClick={() => setActiveTab('grid')}
            className={`px-3 py-1.5 text-sm font-medium rounded-md flex items-center gap-2 transition-colors ${activeTab === 'grid' ? 'bg-slate-100 text-emerald-700' : 'text-slate-600 hover:bg-slate-50'}`}
          >
            <Table size={16} /> Data Grid
          </button>
          <button 
             onClick={() => setActiveTab('pivot')}
             className={`px-3 py-1.5 text-sm font-medium rounded-md flex items-center gap-2 transition-colors ${activeTab === 'pivot' ? 'bg-slate-100 text-emerald-700' : 'text-slate-600 hover:bg-slate-50'}`}
          >
            <BarChart3 size={16} /> Analytics
          </button>
          <div className="h-6 w-px bg-slate-200 mx-2"></div>
          <button className="p-2 text-slate-500 hover:bg-slate-100 rounded-md"><Upload size={18} /></button>
          <button className="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 shadow-sm">
            <Save size={16} /> Export
          </button>
        </div>
      </div>

      {/* 2. FORMULA BAR */}
      <div className="h-10 bg-white border-b border-slate-200 flex items-center px-2 gap-2 text-sm z-10">
        <div className="w-10 text-center text-slate-400 font-serif italic">fx</div>
        <div className="h-6 w-px bg-slate-200"></div>
        <input 
          type="text" 
          value={formula}
          onChange={(e) => setFormula(e.target.value)}
          placeholder={selectedCell ? `Value for Row ${selectedCell.rowId}, ${selectedCell.colId}` : "Select a cell or enter SQL query..."}
          className="flex-1 h-full outline-none text-slate-700 placeholder:text-slate-300 font-mono"
        />
        <button className="p-1 hover:bg-slate-100 rounded text-slate-400"><Calculator size={16}/></button>
      </div>

      {/* 3. MAIN WORKSPACE */}
      <div className="flex-1 overflow-hidden relative flex">
        
        {/* SIDEBAR (Tools) */}
        <div className="w-12 border-r border-slate-200 bg-white flex flex-col items-center py-4 gap-4 z-10">
           <button className="p-2 rounded-lg bg-slate-100 text-emerald-600"><Filter size={18}/></button>
           <button className="p-2 rounded-lg hover:bg-slate-50 text-slate-400"><Plus size={18}/></button>
           <button className="p-2 rounded-lg hover:bg-slate-50 text-slate-400"><Settings size={18}/></button>
        </div>

        {/* DATA GRID */}
        {activeTab === 'grid' && (
          <div className="flex-1 flex flex-col h-full relative">
            
            {/* COLUMN HEADERS */}
            <div className="flex bg-slate-50 border-b border-slate-200 h-8 absolute top-0 left-0 right-0 z-10 ml-12">
               {/* Row Number Column Header */}
               <div className="w-12 flex-shrink-0 border-r border-slate-300 bg-slate-100 flex items-center justify-center absolute left-[-48px] h-full">
                  <div className="w-3 h-3 bg-slate-300 rotate-45"></div>
               </div>
               
               {/* Data Columns */}
               {COLUMNS.map(col => (
                 <div 
                  key={col.id} 
                  style={{ width: col.width }} 
                  className="flex-shrink-0 px-2 flex items-center justify-between border-r border-slate-300 text-xs font-bold text-slate-600 select-none hover:bg-slate-100 cursor-pointer group"
                >
                   {col.name}
                   <ChevronDown size={12} className="text-slate-300 group-hover:text-slate-500" />
                 </div>
               ))}
               <div className="flex-1 bg-slate-50 border-r border-slate-300"></div>
            </div>

            {/* VIRTUAL SCROLL CONTAINER */}
            <div 
              ref={containerRef}
              className="flex-1 overflow-auto bg-white pt-8"
              onScroll={handleScroll}
            >
              {/* PHANTOM DIV FOR HEIGHT */}
              <div style={{ height: totalHeight, position: 'relative' }}>
                
                {/* RENDERED WINDOW */}
                <div style={{ 
                  transform: `translateY(${offsetY}px)`, 
                  position: 'absolute', 
                  width: '100%',
                  top: 0 
                }}>
                  {data.map((row) => (
                    <div 
                      key={row.id} 
                      className="flex border-b border-slate-100 hover:bg-blue-50 transition-colors"
                      style={{ height: ROW_HEIGHT }}
                    >
                      {/* Row Number */}
                      <div className="w-12 flex-shrink-0 bg-slate-50 border-r border-slate-200 flex items-center justify-center text-xs text-slate-400 select-none font-mono">
                        {row.id}
                      </div>

                      {/* Cells */}
                      {COLUMNS.map(col => (
                        <div 
                          key={col.id}
                          style={{ width: col.width }}
                          onClick={() => handleCellClick(row, col.id, row[col.id])}
                          className={`
                            flex-shrink-0 px-2 flex items-center border-r border-slate-100 text-sm truncate cursor-cell
                            ${selectedCell?.rowId === row.id && selectedCell?.colId === col.id ? 'ring-2 ring-emerald-500 z-10 bg-white' : ''}
                            ${col.id === 'total' ? 'font-medium text-slate-700' : 'text-slate-600'}
                            ${col.id === 'status' ? (row.status === 'Completed' ? 'text-emerald-600' : 'text-amber-600') : ''}
                          `}
                        >
                          {col.type === 'currency' ? '$' : ''}{row[col.id]}
                        </div>
                      ))}
                    </div>
                  ))}
                  
                  {/* Loading Skeleton if scrolling fast */}
                  {loading && (
                     <div className="absolute inset-0 bg-white/50 backdrop-blur-[1px] flex items-center justify-center z-20">
                        <div className="bg-white p-2 rounded shadow-lg flex items-center gap-2 text-xs font-medium text-slate-500 border border-slate-100">
                           <Activity size={14} className="animate-spin text-emerald-500"/> Fetching data...
                        </div>
                     </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ANALYTICS TAB MOCKUP */}
        {activeTab === 'pivot' && (
          <div className="flex-1 p-8 bg-slate-50 flex flex-col gap-6 overflow-auto">
             <div className="grid grid-cols-2 gap-6">
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                   <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><BarChart3 size={18}/> Sales by Category</h3>
                   <div className="h-64 flex items-end justify-between px-4 gap-2 border-b border-slate-100 pb-2">
                      {/* Fake Chart Bars */}
                      {[60, 80, 45, 90, 30].map((h, i) => (
                         <div key={i} className="w-full bg-emerald-100 rounded-t-sm relative group hover:bg-emerald-200 transition-all cursor-pointer" style={{height: `${h}%`}}>
                            <div className="absolute -top-6 w-full text-center text-xs font-bold text-slate-600 opacity-0 group-hover:opacity-100">${h}k</div>
                         </div>
                      ))}
                   </div>
                   <div className="flex justify-between px-4 mt-2 text-xs text-slate-400 font-mono">
                      <span>ELEC</span><span>HOME</span><span>OFFC</span><span>TOOL</span><span>GARD</span>
                   </div>
                </div>

                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                   <h3 className="font-bold text-slate-700 mb-4">Pivot Configuration</h3>
                   <div className="space-y-4">
                      <div className="p-3 bg-slate-50 rounded border border-slate-200 border-dashed">
                         <span className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Rows (Group By)</span>
                         <div className="flex gap-2">
                            <span className="bg-white px-2 py-1 rounded shadow-sm border border-slate-200 text-sm flex items-center gap-1">Category <ChevronDown size={12}/></span>
                         </div>
                      </div>
                      <div className="p-3 bg-slate-50 rounded border border-slate-200 border-dashed">
                         <span className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Values (Aggregates)</span>
                         <div className="flex gap-2">
                             <span className="bg-white px-2 py-1 rounded shadow-sm border border-slate-200 text-sm flex items-center gap-1">SUM(Total) <ChevronDown size={12}/></span>
                         </div>
                      </div>
                   </div>
                   <div className="mt-6 p-4 bg-slate-900 text-emerald-400 font-mono text-xs rounded-lg overflow-x-auto">
                      SELECT category, SUM(total)<br/>
                      FROM main_dataset<br/>
                      GROUP BY category
                   </div>
                </div>
             </div>
          </div>
        )}
      </div>
      
      {/* STATUS BAR */}
      <div className="h-6 bg-slate-100 border-t border-slate-200 flex items-center justify-between px-4 text-[10px] text-slate-500 select-none">
         <div className="flex gap-4">
            <span>Ready</span>
            <span className="text-emerald-600 font-medium">DuckDB: Connected</span>
         </div>
         <div className="flex gap-4">
            <span>Average: --</span>
            <span>Count: {selectedCell ? '1' : '0'}</span>
            <span>Sum: --</span>
         </div>
      </div>
    </div>
  );
};

export default App;